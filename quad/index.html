<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Investment Comparison Tool</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: Arial, sans-serif; display: flex; align-items: flex-start; padding: 20px; }
  .sidebar { width: 200px; padding-right: 20px; }
  .container { margin-bottom: 20px; }
  label { display: block; margin-bottom: 5px; }
  input[type="range"] { width: 100%; }
  canvas { width: 100%; max-width: 600px; }
</style>
</head>
<body>
<div class="sidebar">
  <div class="container">
    <label for="presetDropdown">Choose Preset:</label>
    <select id="presetDropdown">
      <option value="montreal">Montreal 850k 4-plex 55k revenue</option>
      <option value="granby">Granby 400k 4-plex 40k revenue</option>
    </select>
  </div>

  <div class="container">
    <label for="initialInvestment">Invest $<span id="initialInvestmentValue">170000</span><span id="propertyPrice"></span></label>
    <input type="range" id="initialInvestment" value="170000" min="60000" max="200000" step="1000">
  </div>

  <div class="container">
    <label for="initialInvestment">MRB: <span id="mrbValue">17</span>x <span id="rentInfo"></span></label>
    <input type="range" id="mrb" value="17" min="7" max="24" step=".1">
  </div>

  <div class="container">
    <label for="annualStockGrowth">Annual Stock Growth: <span id="annualStockGrowthValue">8</span>%</label>
    <input type="range" id="annualStockGrowth" value="8" min="0" max="20" step="0.1">
  </div>

  <div class="container">
    <label for="annualPropertyGrowth">Annual Property Growth: <span id="annualPropertyGrowthValue">4</span>%</label>
    <input type="range" id="annualPropertyGrowth" value="3=4" min="0" max="10" step="0.1">
  </div>

  <div class="container">
    <label for="interestRate">Mortgage Interest Rate: <span id="interestRateValue">4.4</span>%</label>
    <input type="range" id="interestRate" value="4.4" min="1" max="10" step="0.1">
  </div>

  <div class="container">
    <label for="equityOnly">Cashflow covers new loan</label>
    <input type="checkbox" checked id="equityOnly" value="equityOnly">
  </div>

  <div class="container">
    <label for="operatingCosts">Operating Costs (% of Property Value): <span id="operatingCostsValue">1.5</span>%</label>
    <input type="range" id="operatingCosts" value="1.5" min="0" max="5" step="0.1">
  </div>

  <div class="container">
    <label for="rentalIncomeGrowth">Rental Income Growth: <span id="rentalIncomeGrowthValue">3</span>%</label>
    <input type="range" id="rentalIncomeGrowth" value="3" min="0" max="10" step="0.1">
  </div>
</div>

<canvas id="investmentChart"></canvas>

<p id="cashflowinfo"></p>

<script>
  const ctx = document.getElementById('investmentChart').getContext('2d');
  let investmentChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: [],
      datasets: []
    },
    options: {
      animation: false,
      scales: {
        y: {
          min: -200000,
        }
      },
      plugins: {
        tooltip: {
          mode: 'index',
          intersect: false
        }
      },
      responsive: true,
      maintainAspectRatio: false,
    }
  });

  function maxLoanAmount(cashFlow, interestRate, termYears, propertyValue, mortgageBalance, equityOnly = false) {
    const maxLoanFromEquity = propertyValue * 0.8 - mortgageBalance;
    if (equityOnly) return maxLoanFromEquity;

    if (cashFlow <= 0) return 0;
    const r = interestRate;
    const n = termYears;
    const P = cashFlow;  // Maximum annual payment that can be afforded using the extra cash
    if (r === 0) return Math.min(P * n, maxLoanFromEquity);
    else return Math.min(maxLoanFromEquity, P * ((1 + r)**n - 1) / (r * (1 + r)**n));
    }

  function tabulate(series, name) {
    let info = `${name} over years\n`;
    [0, 1, 2, 3, 5, 10, 15, 20, 25, 26].forEach(i => {
       info += `${name} at ${i} years: $${(series[i]).toFixed(0)}\n`;
    });
    return info
  }

  function calculateInvestments() {
    const years = 30;
    const initialInvestment = parseFloat(document.getElementById('initialInvestment').value);
    const propertyPrice = initialInvestment / 0.20;
    document.getElementById('propertyPrice').innerText = `(property ${propertyPrice}`;
    const annualStockGrowth = parseFloat(document.getElementById('annualStockGrowth').value) / 100;
    const annualPropertyGrowth = parseFloat(document.getElementById('annualPropertyGrowth').value) / 100;
    const interestRate = parseFloat(document.getElementById('interestRate').value) / 100;
    const operatingCosts = parseFloat(document.getElementById('operatingCosts').value) / 100;
    const rentalIncomeGrowth = parseFloat(document.getElementById('rentalIncomeGrowth').value) / 100;
    const MRB = parseFloat(document.getElementById('mrb').value);
    const initialRentalIncome = initialInvestment / 0.20 / MRB;
    document.getElementById('rentInfo').innerText = `(rent $${initialRentalIncome.toFixed(0)})`;

    let stockValues = Array.from({length: years+1}, (_, year) => initialInvestment * (1+annualStockGrowth)**year - initialInvestment);
    let propertyValues = Array.from({length: years+1}, (_, year) => initialInvestment / 0.20 * (1 + annualPropertyGrowth)**year);
    let mortgageBalance = Array.from({length: years+1}, (_, year) =>
      year <= 25 ? (initialInvestment / 0.20 - initialInvestment) * ((1 + interestRate)**25 - (1 + interestRate)**year) / ((1 + interestRate)**25 - 1) : 0
    );
    let equity = propertyValues.map((value, index) => value - mortgageBalance[index]);
    let rentalIncomes = Array.from({length: years+1}, (_, year) => (initialInvestment / 0.20 / MRB) * (1 + rentalIncomeGrowth)**year);
    let operatingExpenses = propertyValues.map(value => value * operatingCosts);
    let debtService = mortgageBalance.map((value, index) => 
      index <= 25 ? (initialInvestment / 0.20 - initialInvestment) * interestRate * ((1 + interestRate)**25) / ((1 + interestRate)**25 - 1) : 0
    );
    let cashFlows = Array.from({length: years+1}, (v, index) => rentalIncomes[index] - operatingExpenses[index] - debtService[index]);
    let cumulativeCashFlows = cashFlows.reduce((acc, curr, index) => [...acc, (acc[index-1] || 0) + curr], []);

    let rentalGains = Array.from({length: years+1}, (_, year) => equity[year] + cumulativeCashFlows[year] - initialInvestment);
    let myAge = Array.from({length: years+1}, (_, year) => year + 30);

    let gic = Array.from({length: years+1}, (_, year) => initialInvestment * (1 + interestRate)**year - initialInvestment);
    const equityOnly = !document.getElementById('equityOnly').checked;
    let maxNewLoanAmounts = cashFlows.map((cf, idx) => maxLoanAmount(cf, interestRate, 25, propertyValues[idx], mortgageBalance[idx], equityOnly));

    document.getElementById('cashflowinfo').innerText = tabulate(cashFlows, 'Cash Flow');

    document.getElementById('cashflowinfo').innerText += '\n' + tabulate(maxNewLoanAmounts, 'Refinance');

    document.getElementById('cashflowinfo').innerText += '\n' + tabulate(cumulativeCashFlows, 'Cumulative Cash Flow');


    investmentChart.data.labels = Array.from({length: years+1}, (_, i) => i + 30);
    investmentChart.data.datasets = [
      {
        label: `Stock Gains (${(annualStockGrowth*100).toFixed(1)}%)`,
        data: stockValues,
        type: 'line',
        borderColor: 'rgb(255, 150, 40)',
        backgroundColor: 'rgba(255, 150, 40, 0.5)',
        fill: true,
      },
      {
        label: 'Property Equity',
        data: equity,
        backgroundColor: 'rgba(54, 162, 235, 0.8)',
      },
      {
        label: 'Mortage Balance',
        data: mortgageBalance,
        backgroundColor: 'rgba(255, 0, 0, 0.8)',
      },
      {
        label: 'MaxNewLoan',
        data: maxNewLoanAmounts,
        type: 'line',
        borderColor: 'rgba(255, 255, 0, 0.5)',
        backgroundColor: 'rgba(255, 255, 0, 0.5)',
        fill: true,
      },
      {
        label: 'Monthly Flow',
        data: cashFlows.map(cf => cf / 12),
        backgroundColor: '#ffcc00',
      },
      {
        label: 'Cumulative Cash Flow',
        data: cumulativeCashFlows,
        backgroundColor: '#00ff74',
      },
        {
            label: 'Rental Gains',
            data: rentalGains,
            type: 'line',
            // use a different border color and fill color for this dataset
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.5)',
        fill: true,        },
    ];
    investmentChart.update();
  }

  document.querySelectorAll('input[type="range"]').forEach(input => {
    input.addEventListener('input', function() {
      document.getElementById(input.id + 'Value').innerText = input.value;
      calculateInvestments();
    });
  });

  document.getElementById('equityOnly').addEventListener('change', calculateInvestments);

  document.getElementById('presetDropdown').addEventListener('change', function() {
    document.getElementById('interestRate').value = 4.4;
    document.getElementById('rentalIncomeGrowth').value = 3;
    document.getElementById('annualStockGrowth').value = 8;


    if (this.value === 'montreal') {
      document.getElementById('initialInvestment').value = 170000;
      document.getElementById('mrb').value = 17;
      document.getElementById('annualPropertyGrowth').value = 4;
      document.getElementById('operatingCosts').value = 1.5;
    } else if (this.value === 'granby') {
      document.getElementById('initialInvestment').value = 80000;
      document.getElementById('mrb').value = 12;
      document.getElementById('annualPropertyGrowth').value = 2.5;
      document.getElementById('operatingCosts').value = 2.5;
    }

    // Update the displayed values
    document.getElementById('initialInvestmentValue').textContent = document.getElementById('initialInvestment').value;
    document.getElementById('mrbValue').textContent = document.getElementById('mrb').value;
    document.getElementById('annualStockGrowthValue').textContent = document.getElementById('annualStockGrowth').value;
    document.getElementById('annualPropertyGrowthValue').textContent = document.getElementById('annualPropertyGrowth').value;
    document.getElementById('interestRateValue').textContent = document.getElementById('interestRate').value;
    document.getElementById('operatingCostsValue').textContent = document.getElementById('operatingCosts').value;
    document.getElementById('rentalIncomeGrowthValue').textContent = document.getElementById('rentalIncomeGrowth').value;

    calculateInvestments();
  });

  window.onload = calculateInvestments;
</script>
</body>
</html>
